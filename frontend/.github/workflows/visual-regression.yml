# .github/workflows/visual-regression.yml
#
# Argos CI Visual Regression Testing for Coloring Book Generator
# Adapted from restaurant95-ai pattern using @genesis/visual-regression
#
# Required Secrets:
# - ARGOS_TOKEN: API token from argos-ci.com
#
# P0.47 Compliance: Blocks merge on visual diff detection.

name: Visual Regression

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - '.storybook/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/visual-regression.yml'

  push:
    branches:
      - main
    paths:
      - 'src/**'
      - '.storybook/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/visual-regression.yml'

permissions:
  contents: read
  pull-requests: write
  statuses: write

concurrency:
  group: visual-regression-${{ github.ref }}
  cancel-in-progress: true

jobs:
  visual-regression:
    name: Argos Visual Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Storybook
        run: pnpm storybook:build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Capture Screenshots with Storycap
        run: |
          # Start Storybook server from static build
          npx http-server storybook-static -p 6007 --silent &
          SERVER_PID=$!

          # Wait for server
          npx wait-on http://localhost:6007 --timeout 60000

          # Capture screenshots
          npx storycap http://localhost:6007 -o __screenshots__ --serverCmd '' || true

          # Cleanup
          kill $SERVER_PID || true

          # Verify
          echo "Screenshots captured:"
          find __screenshots__ -name "*.png" | wc -l || echo "No PNG files found"

      - name: Upload to Argos CI
        run: npx @argos-ci/cli upload __screenshots__ --token ${{ secrets.ARGOS_TOKEN }}
        env:
          ARGOS_BUILD_NAME: ${{ github.ref_name }}
          ARGOS_PARALLEL_NONCE: ${{ github.run_id }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## Visual Regression Test Results

            Argos CI has captured visual snapshots for this PR.

            **Action Required:**
            - Review visual changes in the [Argos Dashboard](https://app.argos-ci.com)
            - Approve or reject changes before merging

            **What gets tested:**
            - All component stories (8 components, dark + light themes)
            - Responsive viewport sizes (mobile, tablet, desktop)

            **Threshold:** 0.1% pixel difference tolerance

            ---
            _Visual testing powered by [Argos CI](https://argos-ci.com) and @genesis/visual-regression_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Visual Regression Test Results')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  visual-regression-check:
    name: Visual Regression Required
    runs-on: ubuntu-latest
    needs: visual-regression
    if: github.event_name == 'pull_request'

    steps:
      - name: Check Argos Status
        run: |
          echo "Visual regression tests completed."
          echo "Review and approve changes in Argos dashboard before merging."
