# .github/workflows/storybook-deploy.yml
#
# Build Storybook and deploy to GitHub Pages on push to main.
# Uses the same standalone CI context pattern as visual-regression.yml.

name: Deploy Storybook

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/src/**'
      - 'frontend/.storybook/**'
      - 'frontend/package.json'

permissions:
  pages: write
  id-token: write
  contents: read

concurrency:
  group: storybook-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build & Deploy Storybook
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: frontend/package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare standalone context
        run: |
          # Strip workspace:* deps (only available in monorepo context)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            for (const [name, ver] of Object.entries(pkg.devDependencies || {})) {
              if (String(ver).startsWith('workspace:')) delete pkg.devDependencies[name];
            }
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          # Inline tsconfig (replaces @genesis/tsconfig which is workspace-only)
          cat > tsconfig.json << 'TSEOF'
          {
            "compilerOptions": {
              "target": "ES2020",
              "module": "ESNext",
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "skipLibCheck": true,
              "moduleResolution": "bundler",
              "allowImportingTsExtensions": true,
              "isolatedModules": true,
              "moduleDetection": "force",
              "noEmit": true,
              "resolveJsonModule": true,
              "strict": true,
              "noUnusedLocals": false,
              "noUnusedParameters": false,
              "noFallthroughCasesInSwitch": true,
              "useDefineForClassFields": true,
              "jsx": "preserve",
              "baseUrl": ".",
              "paths": { "@/*": ["./src/*"] }
            },
            "include": ["src/**/*.ts", "src/**/*.tsx", "src/**/*.vue"],
            "references": [{ "path": "./tsconfig.node.json" }]
          }
          TSEOF
          cat > tsconfig.node.json << 'TSEOF'
          {
            "compilerOptions": {
              "composite": true,
              "skipLibCheck": true,
              "module": "ESNext",
              "moduleResolution": "bundler",
              "allowSyntheticDefaultImports": true,
              "strict": true
            },
            "include": ["vite.config.ts"]
          }
          TSEOF

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build Storybook
        run: pnpm storybook:build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/storybook-static

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
