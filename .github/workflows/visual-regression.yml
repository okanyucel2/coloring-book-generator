# .github/workflows/visual-regression.yml
#
# Argos CI Visual Regression Testing for Coloring Book Generator
# Adapted from restaurant95-ai pattern using @genesis/visual-regression
#
# Required Secrets:
# - ARGOS_TOKEN: API token from argos-ci.com
#
# P0.47 Compliance: Blocks merge on visual diff detection.

name: Visual Regression

on:
  pull_request:
    branches:
      - main
    paths:
      - 'frontend/src/**'
      - 'frontend/.storybook/**'
      - 'frontend/package.json'
      - '.github/workflows/visual-regression.yml'

  push:
    branches:
      - main
    paths:
      - 'frontend/src/**'
      - 'frontend/.storybook/**'
      - 'frontend/package.json'
      - '.github/workflows/visual-regression.yml'

permissions:
  contents: read
  pull-requests: write
  statuses: write

concurrency:
  group: visual-regression-${{ github.ref }}
  cancel-in-progress: true

jobs:
  visual-regression:
    name: Argos Visual Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: frontend/package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare standalone context
        run: |
          # Strip workspace:* deps (only available in monorepo context)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            for (const [name, ver] of Object.entries(pkg.devDependencies || {})) {
              if (String(ver).startsWith('workspace:')) delete pkg.devDependencies[name];
            }
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          # Inline tsconfig (replaces @genesis/tsconfig which is workspace-only)
          cat > tsconfig.json << 'TSEOF'
          {
            "compilerOptions": {
              "target": "ES2020",
              "module": "ESNext",
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              "skipLibCheck": true,
              "moduleResolution": "bundler",
              "allowImportingTsExtensions": true,
              "isolatedModules": true,
              "moduleDetection": "force",
              "noEmit": true,
              "resolveJsonModule": true,
              "strict": true,
              "noUnusedLocals": false,
              "noUnusedParameters": false,
              "noFallthroughCasesInSwitch": true,
              "useDefineForClassFields": true,
              "jsx": "preserve",
              "baseUrl": ".",
              "paths": { "@/*": ["./src/*"] }
            },
            "include": ["src/**/*.ts", "src/**/*.tsx", "src/**/*.vue"],
            "references": [{ "path": "./tsconfig.node.json" }]
          }
          TSEOF
          cat > tsconfig.node.json << 'TSEOF'
          {
            "compilerOptions": {
              "composite": true,
              "skipLibCheck": true,
              "module": "ESNext",
              "moduleResolution": "bundler",
              "allowSyntheticDefaultImports": true,
              "strict": true
            },
            "include": ["vite.config.ts"]
          }
          TSEOF

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build Storybook
        run: pnpm storybook:build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Capture Screenshots with Storycap
        run: |
          # Start Storybook server from static build
          npx http-server storybook-static -p 6007 --silent &
          SERVER_PID=$!

          # Wait for server
          npx wait-on http://localhost:6007 --timeout 60000

          # Capture screenshots
          npx storycap http://localhost:6007 -o __screenshots__ --serverCmd '' || true

          # Cleanup
          kill $SERVER_PID || true

          # Verify
          echo "Screenshots captured:"
          find __screenshots__ -name "*.png" | wc -l || echo "No PNG files found"

      - name: Upload to Argos CI
        run: npx @argos-ci/cli upload __screenshots__ --token ${{ secrets.ARGOS_TOKEN }}
        env:
          ARGOS_BUILD_NAME: ${{ github.ref_name }}
          ARGOS_PARALLEL_NONCE: ${{ github.run_id }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## Visual Regression Test Results

            Argos CI has captured visual snapshots for this PR.

            **Action Required:**
            - Review visual changes in the [Argos Dashboard](https://app.argos-ci.com)
            - Approve or reject changes before merging

            **What gets tested:**
            - All component stories (8 components, dark + light themes)
            - Responsive viewport sizes (mobile, tablet, desktop)

            **Threshold:** 0.1% pixel difference tolerance

            ---
            _Visual testing powered by [Argos CI](https://argos-ci.com) and @genesis/visual-regression_`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Visual Regression Test Results')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  visual-regression-check:
    name: Visual Regression Required
    runs-on: ubuntu-latest
    needs: visual-regression
    if: github.event_name == 'pull_request'

    steps:
      - name: Check Argos Status
        run: |
          echo "Visual regression tests completed."
          echo "Review and approve changes in Argos dashboard before merging."
